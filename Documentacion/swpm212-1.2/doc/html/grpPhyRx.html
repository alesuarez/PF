<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>SWPM AT86RF212: Frame Receive Procedure (RX)</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.6 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="main.html">AT86RF212 Programming</a>&nbsp;&raquo&nbsp;<a class="el" href="pgSwpmAT86RF212.html">Software Programming Model</a>&nbsp;&raquo&nbsp;<a class="el" href="grpBasic.html">Basic Operating Mode</a>
  </div>
</div>
<div class="contents">
<h1><a class="anchor" name="grpPhyRx">Frame Receive Procedure (RX) </a></h1>For receiving frames in the Basic Operating Mode, the radio transceiver needs to be in the state <a class="el" href="grpIntroStates.html#stRxOn">RX_ON</a>, as described in section <a class="el" href="grpStateRxOn.html">Transitions to State RX_ON</a>.<p>
The end of a frame reception is indicated by the <a class="el" href="group__apiHalPHY212Const.html#ge34c1f5817526945d96c7cda6689f342">TRX_IRQ_TRX_END</a> interrupt. At the same time, the sub register <a class="el" href="group__apiHalPHY212Sreg.html#g80bd45c004ff677a0295b38070f38cb0">SR_RX_CRC_VALID</a> is updated with the result of the FCS check. The value {1} in this sub register indicates, that the received frame contains a correct CRC16.<p>
<a class="anchor" name="phySpiFrameRx"></a> A received frame is stored in the frame buffer of the radio transceiver in the following way:<p>
<pre></pre><p>
<pre>             0   1   2                         L-1  L  L+1 L+2 L+3
           +--- --- --- --- --- --- --- ~~~~~~ --- ---+--- --- ---+
           | P | D | D | D | D | D | D |      |D/F|D/F|LQI|ED |RXS|
           +--- --- --- --- --- --- --- ~~~~~~ --- ---+--- --- ---+
           |                                          |           |
           |&lt;--- access via "SRAM Read Access"  -----&gt;|           |
           |                                                      |
           |&lt;--- access via "Frame Read Access"  ----------------&gt;|</pre><p>
<pre>      P   : PHR field containing the PSDU length information L
      D,F : D = data byte, F = FCS byte (D and F belong to the PSDU)
      LQI : link quality indication value for the received frame
      ED  : energy value for the received frame
      RXS : RX_STATUS value for the received frame</pre><p>
<pre>  </pre><p>
The PHR field of a received frame contains the PSDU length L, which has a valid range from {1,...,127}. The PHR field and the PSDU bytes can be read with the functions <a class="el" href="group__apiHalFuncBasic.html#g88ff4f45a0c4c7435d686150cc7fb4c2">trx_frame_read()</a> and/or <a class="el" href="group__apiHalFuncBasic.html#g9cefef2438958ba66d3696eb01aa8470">trx_sram_read()</a>. The <a class="el" href="grpPhyFrameInfo.html">RX Frame Status Information</a> (LQI, ED, RX_STATUS) is stored directly after the last byte of the PSDU and is only accessible with the function <a class="el" href="group__apiHalFuncBasic.html#g88ff4f45a0c4c7435d686150cc7fb4c2">trx_frame_read()</a>.<p>
<b>Use Cases:</b><ul>
<li><a class="el" href="grpPhyRx.html#secphy_data_indication">PHY_DATA_INDICATION_MATCH</a></li><li><a class="el" href="grpPhyRx.html#secphy_data_indication_nomatch">PHY_DATA_INDICATION_NOMATCH</a></li><li><a class="el" href="grpPhyRx.html#secphy_data_indication_sw_ack">PHY_DATA_INDICATION_FAST</a></li></ul>
<p>
<hr>
<h2><a class="anchor" name="secphy_data_indication">
PHY_DATA_INDICATION_MATCH</a></h2>
This procedure loads the frame from the radio transceiver, when it is completely received and stored in the frame buffer. In this use case it is assumed, that the incoming frame passes the <a class="el" href="grpSetAddr.html">Address Filter</a> and thus the interrupt <a class="el" href="group__apiHalPHY212Const.html#gf6899ef98af446c018af6fa8d9f414dc">TRX_IRQ_AMI</a> occurs. If the entire frame buffer read takes longer than <a class="el" href="pgConst.html#tMSNC">tMSNC</a>, there is a risk, that the currently stored frame is overwritten by the next frame being received. This can be avoided with one of the procedures described in <a class="el" href="grpFProt.html">Frame Buffer Protection (Static/Dynamic)</a>.<p>
<div align="center">
<img src="inline_mscgraph_79.png" alt="inline_mscgraph_79" border="0" usemap="#inline_mscgraph_79.map">
<map name="inline_mscgraph_79.map"><area href="grpIntroStates.html#stRxOn" shape="rect" coords="436,26,464,39" alt="">
<area href="grpIntroStates.html#stRxBusy" shape="rect" coords="430,76,470,89" alt="">
<area href="grpIntroStates.html#stRxOn" shape="rect" coords="436,251,464,264" alt="">
<area href="pgConst.html#tSHR" shape="rect" coords="160,269,189,282" alt="">
</map>
</div>
 <dl class="user" compact><dt><b>Code example</b></dt><dd><div class="fragment"><pre class="fragment">    <span class="comment">/* AT86RF212::RX_ON &amp;&amp; AT86RF212::BUSY_RX */</span>
    <span class="comment">/* TRX_IRQ_RX_START occurs here */</span>
    <span class="comment">/* TRX_IRQ_AMI occurs here */</span>
    <span class="comment">/* TRX_IRQ_TRX_END occurs here */</span>
    <span class="comment">/* AT86RF212::RX_ON */</span>
    crc_valid = <a class="code" href="group__apiHalFuncBasic.html#ge7ea3d090b5d26b73a5c62e2e61e0231" title="Read a value from a subregister.">trx_bit_read</a>(<a class="code" href="group__apiHalPHY212Sreg.html#g80bd45c004ff677a0295b38070f38cb0">SR_RX_CRC_VALID</a>);
    frame = <a class="code" href="group__apiHalFuncBasic.html#g88ff4f45a0c4c7435d686150cc7fb4c2" title="Read a frame from the radio transceiver.">trx_frame_read</a>();
</pre></div></dd></dl>
<h2><a class="anchor" name="secphy_data_indication_nomatch">
PHY_DATA_INDICATION_NOMATCH</a></h2>
This use case describes the same procedure as <a class="el" href="grpPhyRx.html#secphy_data_indication">PHY_DATA_INDICATION_MATCH</a>. The only difference is that the address field of the incoming frame does not pass the frame filter according to the filter rules described in <a class="el" href="pgRef.html#refDataSheet">section 6.2</a> <em>(Frame Filter)</em> of the AT86RF212 datasheet. Thus, no <a class="el" href="group__apiHalPHY212Const.html#gf6899ef98af446c018af6fa8d9f414dc">TRX_IRQ_AMI</a> occurs.<p>
<div align="center">
<img src="inline_mscgraph_80.png" alt="inline_mscgraph_80" border="0" usemap="#inline_mscgraph_80.map">
<map name="inline_mscgraph_80.map"><area href="grpIntroStates.html#stRxOn" shape="rect" coords="436,26,464,39" alt="">
<area href="grpIntroStates.html#stRxBusy" shape="rect" coords="430,76,470,89" alt="">
<area href="grpIntroStates.html#stRxOn" shape="rect" coords="436,226,464,239" alt="">
</map>
</div>
 <dl class="user" compact><dt><b>Code example</b></dt><dd><div class="fragment"><pre class="fragment">    <span class="comment">/* AT86RF212::RX_ON &amp;&amp; AT86RF212::BUSY_RX */</span>
    <span class="comment">/* TRX_IRQ_RX_START occurs here */</span>
    <span class="comment">/* TRX_IRQ_TRX_END occurs here */</span>
    <span class="comment">/* AT86RF212::RX_ON */</span>
    crc_valid = <a class="code" href="group__apiHalFuncBasic.html#ge7ea3d090b5d26b73a5c62e2e61e0231" title="Read a value from a subregister.">trx_bit_read</a>(<a class="code" href="group__apiHalPHY212Sreg.html#g80bd45c004ff677a0295b38070f38cb0">SR_RX_CRC_VALID</a>);
    frame = <a class="code" href="group__apiHalFuncBasic.html#g88ff4f45a0c4c7435d686150cc7fb4c2" title="Read a frame from the radio transceiver.">trx_frame_read</a>();
</pre></div></dd></dl>
<h2><a class="anchor" name="secphy_data_indication_sw_ack">
PHY_DATA_INDICATION_FAST</a></h2>
In order to meet the strict timing constraints of the acknowledgement procedure in the IEEE 802.15.4 standard, the frame buffer can be read in parallel to the frame reception. In order to avoid a <a class="el" href="grpIrqUR.html#secphy_event_fifounderrun_rx">RX underrun condition</a>, the frame read procedure has to be started so, that it is finished after the last PSDU octet of the frame is received.<p>
After the <a class="el" href="group__apiHalPHY212Const.html#gab5ff5ca963c7556f4f1e0e37f045604">TRX_IRQ_RX_START</a> interrupt the PHR field is read in order to determine the frame length <code>flen</code> (see <a class="el" href="group__apiHalFuncBasic.html#gdc224f06f02dbaac91c0a7d49b6a8a4e">trx_frame_length_read()</a>). The value <a class="el" href="grpPhyRx.html#twait">twait</a> denotes the waiting time before the frame buffer read is started. It depends on the SPI transfer rate <code>Rspi [octets/s]</code>, the data rate <code>Rdata [octets/s]</code> and the frame length <code>flen [octets]</code>. It is computed according the following formula:<p>
<a class="anchor" name="twait"></a> <code> twait [s] &gt; flen *(1/Rdata-1/Rspi)</code><p>
When the <a class="el" href="group__apiHalPHY212Const.html#ge34c1f5817526945d96c7cda6689f342">TRX_IRQ_TRX_END</a> interrupt occurs, the frame is already uploaded in a buffer and the acknowledge procedure can be started immediately.<p>
<dl class="note" compact><dt><b>Note:</b></dt><dd>If the frame upload is started earlier than <a class="el" href="grpPhyRx.html#twait">twait</a>, a <a class="el" href="group__apiHalPHY212Const.html#gdfe439356d965b05adfe5d3a206e249b">TRX_IRQ_TRX_UR</a> interrupt is generated and the data has to be uploaded again (see <a class="el" href="grpIrqUR.html#secphy_event_fifounderrun_rx">PHY_EVENT_TRX_UR_RX</a>). However, this can be avoided by using the <a class="el" href="grpBEmpty.html">Frame Buffer Empty Indicator</a>. In this case, the calculation of <a class="el" href="grpPhyRx.html#twait">twait</a> and the corresponding delay is not needed.</dd></dl>
<div align="center">
<img src="inline_mscgraph_81.png" alt="inline_mscgraph_81" border="0" usemap="#inline_mscgraph_81.map">
<map name="inline_mscgraph_81.map"><area href="grpIntroStates.html#stRxOn" shape="rect" coords="436,26,464,39" alt="">
<area href="grpIntroStates.html#stRxBusy" shape="rect" coords="430,76,470,89" alt="">
<area href="grpPhyRx.html#twait" shape="rect" coords="160,194,195,207" alt="">
<area href="grpIntroStates.html#stRxOn" shape="rect" coords="436,326,464,339" alt="">
</map>
</div>
 <dl class="user" compact><dt><b>Code example</b></dt><dd><div class="fragment"><pre class="fragment">    <span class="comment">/* AT86RF212::RX_ON &amp;&amp; AT86RF212::BUSY_RX */</span>
    <span class="comment">/* TRX_IRQ_RX_START occurs here */</span>
    flen = <a class="code" href="group__apiHalFuncBasic.html#gdc224f06f02dbaac91c0a7d49b6a8a4e" title="Read the length of a received frame.">trx_frame_length_read</a>();
    delay(twait);
    frame = <a class="code" href="group__apiHalFuncBasic.html#g88ff4f45a0c4c7435d686150cc7fb4c2" title="Read a frame from the radio transceiver.">trx_frame_read</a>();
    <span class="comment">/* TRX_IRQ_TRX_END occurs here */</span>
    <span class="comment">/* AT86RF212::RX_ON */</span>
    generate_ack(frame);
</pre></div> </dd></dl>
</div>
<hr size="1"><address style="text-align: right;"><small>Generated on Mon Aug 17 13:35:01 2009 for SWPM AT86RF212 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.6 </small></address>
</body>
</html>
