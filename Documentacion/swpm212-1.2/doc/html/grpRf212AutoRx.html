<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>SWPM AT86RF212: Extended Frame Receive Procedure (RX_AACK)</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.6 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="main.html">AT86RF212 Programming</a>&nbsp;&raquo&nbsp;<a class="el" href="pgSwpmAT86RF212.html">Software Programming Model</a>&nbsp;&raquo&nbsp;<a class="el" href="grpRf212Auto.html">Extended Operating Mode</a>
  </div>
</div>
<div class="contents">
<h1><a class="anchor" name="grpRf212AutoRx">Extended Frame Receive Procedure (RX_AACK) </a></h1>This section describes how the parameters for the Extended Operating Mode are configured and how frames are received in the RX_AACK mode.<p>
In the RX_AACK operating mode, described in <a class="el" href="pgRef.html#refDataSheet">section 5.2.3</a> <em>(RX_AACK_ON Receive with Automatic ACK)</em> of the AT86RF212 datasheet, incoming frames are checked against the address filter and for a valid FCS. If these checks are passed, the <a class="el" href="group__apiHalPHY212Const.html#ge34c1f5817526945d96c7cda6689f342">TRX_IRQ_TRX_END</a> interrupt is generated at the end of the received frame and an optional required acknowledgement frame is transmitted.<p>
<a class="anchor" name="parm_coord"></a> <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>coord</em>&nbsp;</td><td>This bit specifies, whether the radio transceiver is operated as PAN coordinator {1} or as device {0}. <a class="anchor" name="parm_pendd"></a> </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>pendd</em>&nbsp;</td><td>This bit specifies, whether the device has pending data. During generation of an acknowledgment, the radio transceiver will copy this bit into the frame pending subfield of the frame control field in response to a data request MAC command. <a class="anchor" name="parm_slmode"></a> </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>slmode</em>&nbsp;</td><td>This bit specifies, whether the radio transceiver is operated in slotted {1} or unslotted {0} operation mode, as described in <a class="el" href="pgRef.html#refDataSheet">section 5.2.3.5</a> <em>(Slotted Operation, Slotted Acknowledgement)</em> of the AT86RF212 datasheet.</td></tr>
  </table>
</dl>
<a class="anchor" name="retv_tracstat"></a> <dl compact><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>tracstat</em>&nbsp;</td><td>Result of a RX_AACK transaction from sub register <a class="el" href="group__apiHalPHY212Sreg.html#g4692d9ea2770ff145d1c35c513cbf1d6">SR_TRAC_STATUS</a> :<ul>
<li><a class="el" href="group__apiHalPHY212Const.html#g055049d569c7e50ecb31baa46ab3d6c1">TRAC_SUCCESS</a> : The frame reception was successful.</li><li><a class="el" href="group__apiHalPHY212Const.html#g963a197c74012c7568d3229ff884c231">TRAC_SUCCESS_WAIT_FOR_ACK</a> : This value occurs if the parameter <code>slmode</code> is set to 1 and the received frame requests an acknowledgement. In this case the sending of the acknowledgement frame needs to be initiated from the MCU by pulling <a class="el" href="grpIntroMCU.html#wirePinSleepTr">TRX_PIN_SLP_TR</a>.</li><li><a class="el" href="group__apiHalPHY212Const.html#gd43f24dc2040e71f091bdc2377aa063b">TRAC_INVALID</a> : The ongoing transaction was aborted.</li></ul>
</td></tr>
  </table>
</dl>
<dl class="note" compact><dt><b>Note:</b></dt><dd>The Extended Operating Mode of the radio transceiver was designed to handle the requirements of the IEEE 802.15.4 standard. The section <a class="el" href="grpRf212CfgAutoRx.html">Extended Configuration of RX_AACK mode</a> describes how the RX_AACK mode can be used for proprietary and non-standard compliant operations.</dd></dl>
<b>Use Cases:</b><ul>
<li><a class="el" href="grpSetAddr.html#secaddr_filter_cfg">PHY_CFG_ADDRESS_FILTER</a></li><li><a class="el" href="grpRf212AutoRx.html#secphy_set_autorx_afilt">PHY_CONFIG_RX_AACK</a></li><li><a class="el" href="grpRf212AutoRx.html#secphy_set_autorx_set_pd">PHY_SET_PD</a></li><li><a class="el" href="grpRf212AutoRx.html#secphy_set_autorx_set_pd_busy">PHY_SET_PD_BUSY</a></li><li><a class="el" href="grpRf212AutoRx.html#secphy_data_indication_autorx_unslotted">PHY_DATA_INDICATION_RX_AACK_UNSLOTTED</a></li><li><a class="el" href="grpRf212AutoRx.html#secphy_data_indication_autorx_slotted">PHY_DATA_INDICATION_RX_AACK_SLOTTED</a></li></ul>
<p>
<hr>
<h2><a class="anchor" name="secphy_set_autorx_afilt">
PHY_CONFIG_RX_AACK</a></h2>
The following sequence should be used to configure the RX_AACK mode.<p>
<div align="center">
<img src="inline_mscgraph_85.png" alt="inline_mscgraph_85" border="0" usemap="#inline_mscgraph_85.map">
<map name="inline_mscgraph_85.map"><area href="grpIntroStates.html#stTrxConfig" shape="rect" coords="427,26,473,39" alt="">
</map>
</div>
 <dl class="user" compact><dt><b>Code example</b></dt><dd><div class="fragment"><pre class="fragment">    <span class="comment">/* AT86RF212::[CONFIG] */</span>
    <a class="code" href="group__apiHalFuncBasic.html#g4a22a30602ea72effde4450ce80a6480" title="Write a value to a subregister.">trx_bit_write</a>(<a class="code" href="group__apiHalPHY212Sreg.html#ga6921e48f6974a68e6f65f7721e237f4">SR_AACK_I_AM_COORD</a>, coord);
    <a class="code" href="group__apiHalFuncBasic.html#g4a22a30602ea72effde4450ce80a6480" title="Write a value to a subregister.">trx_bit_write</a>(<a class="code" href="group__apiHalPHY212Sreg.html#g254fc54f1861f36bdcc002dfa3ddbba4">SR_SLOTTED_OPERATION</a>, slmode);
</pre></div></dd></dl>
<h2><a class="anchor" name="secphy_set_autorx_set_pd">
PHY_SET_PD</a></h2>
The following sequence is used to set the pending data bit <code>pendd</code> in an automatically generated acknowledgement frame. After the reception of a MAC command frame of type "Data Request" (command frame identifier 0x04), the content of the sub register <a class="el" href="group__apiHalPHY212Sreg.html#g924acfc6524e3b4273f0d94b4b502382">SR_AACK_SET_PD</a> is copied into the frame pending subfield of the generated acknowledgement frame (see section 7.2.2.3.1 of the IEEE 802.15.4-2006 standard). For all other frames requesting an ACK, the frame pending subfield is set to 0, regardless of the content of sub register <a class="el" href="group__apiHalPHY212Sreg.html#g924acfc6524e3b4273f0d94b4b502382">SR_AACK_SET_PD</a>.<p>
<dl class="note" compact><dt><b>Note:</b></dt><dd>In order to set the pending data bit when the radio transceiver is in state <a class="el" href="grpIntroStates.html#stRxAackBusy">BUSY_RX_AACK</a>, the sequence <a class="el" href="grpRf212AutoRx.html#secphy_set_autorx_set_pd_busy">PHY_SET_PD_BUSY</a> is used.</dd></dl>
<div align="center">
<img src="inline_mscgraph_86.png" alt="inline_mscgraph_86" border="0" usemap="#inline_mscgraph_86.map">
<map name="inline_mscgraph_86.map"><area href="grpIntroStates.html#stTrxActive" shape="rect" coords="427,26,473,39" alt="">
</map>
</div>
 <dl class="user" compact><dt><b>Code example</b></dt><dd><div class="fragment"><pre class="fragment">    <span class="comment">/* AT86RF212::[ACTIVE] */</span>
    <a class="code" href="group__apiHalFuncBasic.html#g4a22a30602ea72effde4450ce80a6480" title="Write a value to a subregister.">trx_bit_write</a>(<a class="code" href="group__apiHalPHY212Sreg.html#g924acfc6524e3b4273f0d94b4b502382">SR_AACK_SET_PD</a>, pendd);
</pre></div></dd></dl>
<h2><a class="anchor" name="secphy_set_autorx_set_pd_busy">
PHY_SET_PD_BUSY</a></h2>
The following sequence is used to set the pending data bit <code>pendd</code> during state <a class="el" href="grpIntroStates.html#stRxAackBusy">BUSY_RX_AACK</a>. After the interrupt <a class="el" href="group__apiHalPHY212Const.html#gf6899ef98af446c018af6fa8d9f414dc">TRX_IRQ_AMI</a> the frame upload can be started using the <a class="el" href="grpBEmpty.html">Frame Buffer Empty Indicator</a> sequence. With the interrupt <a class="el" href="group__apiHalPHY212Const.html#ge34c1f5817526945d96c7cda6689f342">TRX_IRQ_TRX_END</a> occured, the frame upload is finished and the value of <code>pendd</code> can be computed within <a class="el" href="pgConst.html#tTxAck">tTxAck</a> in order to take effect with the automatically generated acknowledgement frame.<p>
<div align="center">
<img src="inline_mscgraph_87.png" alt="inline_mscgraph_87" border="0" usemap="#inline_mscgraph_87.map">
<map name="inline_mscgraph_87.map"><area href="pgConst.html#tTxAck" shape="rect" coords="160,194,201,207" alt="">
</map>
</div>
 <dl class="user" compact><dt><b>Code example</b></dt><dd><div class="fragment"><pre class="fragment">    <span class="comment">/* AT86RF212::[BUSY_RX_AACK] */</span>
    <span class="comment">/* TRX_IRQ_AMI occurs here */</span>
    frm = <a class="code" href="group__apiHalFuncBasic.html#gee1a17975e51ef9df001ff17be1cf6f5" title="Read frame in buffer level mode.">trx_frame_read_blm</a>();
    <span class="comment">/* TRX_IRQ_TRX_END occurs here */</span>
    pendd = proc_frm(frm);
    <a class="code" href="group__apiHalFuncBasic.html#g4a22a30602ea72effde4450ce80a6480" title="Write a value to a subregister.">trx_bit_write</a>(<a class="code" href="group__apiHalPHY212Sreg.html#g924acfc6524e3b4273f0d94b4b502382">SR_AACK_SET_PD</a>, pendd);
</pre></div></dd></dl>
<h2><a class="anchor" name="secphy_data_indication_autorx_unslotted">
PHY_DATA_INDICATION_RX_AACK_UNSLOTTED</a></h2>
The result of a RX_AACK transaction is stored in the sub register <a class="el" href="group__apiHalPHY212Sreg.html#g4692d9ea2770ff145d1c35c513cbf1d6">SR_TRAC_STATUS</a> after the <a class="el" href="group__apiHalPHY212Const.html#ge34c1f5817526945d96c7cda6689f342">TRX_IRQ_TRX_END</a> interrupt. In unslotted operation mode, <a class="el" href="grpRf212AutoRx.html#retv_tracstat">tracstat</a> can be either <a class="el" href="group__apiHalPHY212Const.html#g055049d569c7e50ecb31baa46ab3d6c1">TRAC_SUCCESS</a> or <a class="el" href="group__apiHalPHY212Const.html#gd43f24dc2040e71f091bdc2377aa063b">TRAC_INVALID</a>.<p>
The transmission of the ACK frame starts <a class="el" href="pgConst.html#tWaitAck">tWaitAck</a> after the end of the frame reception. The complete ACK frame is on air after <a class="el" href="pgConst.html#tAckDone">tAckDone</a>.<p>
The internal timing for the ACK frame processing in RX_AACK mode is shown below:<p>
<pre></pre><p>
<pre>  == RX ==:======================= TX =========================:======= RX =======
         0         12                                        100  BPSK
         0         12                                         34  OQPSK
     +---|         |---+---+---+---+---+---+---+---+---+---+---|     time [symbols]
   --| F |---------|   Preamble    |SFD|PHR|   ACK frame       |------------------&gt;
     +---|         |---+---+---+---+---+---+---+---+---+---+---|
         |         |                                           |
         t0        t1                                          t2</pre><p>
<pre> </pre><p>
<ul>
<li>t0 : At this point in time the interrupt <a class="el" href="group__apiHalPHY212Const.html#ge34c1f5817526945d96c7cda6689f342">TRX_IRQ_TRX_END</a> is generated.</li><li>t1 : The transmission of the ACK frame is started (see <a class="el" href="pgConst.html#tWaitAck">tWaitAck</a>).</li><li>t2 : The transmission of the ACK frame is completed (see <a class="el" href="pgConst.html#tAckDone">tAckDone</a>).</li></ul>
<p>
<dl class="note" compact><dt><b>Note:</b></dt><dd><br>
<small><b>&gt;&gt;</b></small>&nbsp; If an acknowledgement frame has to be transmitted, the radio transceiver stays in state <a class="el" href="grpIntroStates.html#stRxAackBusy">BUSY_RX_AACK</a> for the duration <a class="el" href="pgConst.html#tAckDone">tAckDone</a> (t2) after the interrupt <a class="el" href="group__apiHalPHY212Const.html#ge34c1f5817526945d96c7cda6689f342">TRX_IRQ_TRX_END</a>. <br>
<small><b>&gt;&gt;</b></small>&nbsp; The state <a class="el" href="grpIntroStates.html#stRxAackBusy">BUSY_RX_AACK</a> can be left immediately by writing <a class="el" href="group__apiHalPHY212Const.html#g8ecc63755abb125691b00426cba7fe41">CMD_FORCE_TRX_OFF</a> or <a class="el" href="group__apiHalPHY212Const.html#g12eaacbac3b035bafe907c53dbce70dd">CMD_FORCE_PLL_ON</a> to sub register <a class="el" href="group__apiHalPHY212Sreg.html#g8d912618842812f37fc46356eff73c93">SR_TRX_CMD</a>.</dd></dl>
<div align="center">
<img src="inline_mscgraph_88.png" alt="inline_mscgraph_88" border="0" usemap="#inline_mscgraph_88.map">
<map name="inline_mscgraph_88.map"><area href="grpIntroStates.html#stRxAackOn" shape="rect" coords="421,26,479,39" alt="">
<area href="grpIntroStates.html#stRxAackBusy" shape="rect" coords="415,76,485,89" alt="">
<area href="pgConst.html#tFrame" shape="rect" coords="160,119,201,132" alt="">
<area href="pgConst.html#tAckDone" shape="rect" coords="460,194,513,207" alt="">
<area href="grpIntroStates.html#stRxAackOn" shape="rect" coords="421,326,479,339" alt="">
</map>
</div>
 <dl class="user" compact><dt><b>Code example</b></dt><dd><div class="fragment"><pre class="fragment">    <span class="comment">/* AT86RF212::RX_AACK_ON &amp;&amp; AT86RF212::BUSY_RX_AACK */</span>
    delay(tFrame);
    tracstat = <a class="code" href="group__apiHalFuncBasic.html#ge7ea3d090b5d26b73a5c62e2e61e0231" title="Read a value from a subregister.">trx_bit_read</a>(<a class="code" href="group__apiHalPHY212Sreg.html#g4692d9ea2770ff145d1c35c513cbf1d6">SR_TRAC_STATUS</a>);
    frm = <a class="code" href="group__apiHalFuncBasic.html#g88ff4f45a0c4c7435d686150cc7fb4c2" title="Read a frame from the radio transceiver.">trx_frame_read</a>();
    <span class="comment">/* AT86RF212::RX_AACK_ON */</span>
</pre></div></dd></dl>
<h2><a class="anchor" name="secphy_data_indication_autorx_slotted">
PHY_DATA_INDICATION_RX_AACK_SLOTTED</a></h2>
Section 7.5.6.4.2. of the IEEE 802.15.4-2006 standard states that "The transmission of an acknowledgment frame in the CAP shall commence either aTurnaroundTime symbols after the reception of the last symbol of the data or MAC command frame or at a backoff slot boundary." The AT86RF212 supports both ACK transmission modes. In order to activate the ACK transmission on slot boundaries the <a class="el" href="group__apiHalPHY212Sreg.html#g254fc54f1861f36bdcc002dfa3ddbba4">SR_SLOTTED_OPERATION</a> bit needs to be set. If an ACK frame has to be transmitted, the radio transceiver expects a rising edge on <a class="el" href="grpIntroMCU.html#wirePinSleepTr">TRX_PIN_SLP_TR</a> to actually start the transmission.<p>
The result <a class="el" href="grpRf212AutoRx.html#retv_tracstat">tracstat</a> of a RX_AACK transaction is stored in the sub register <a class="el" href="group__apiHalPHY212Sreg.html#g4692d9ea2770ff145d1c35c513cbf1d6">SR_TRAC_STATUS</a> after the <a class="el" href="group__apiHalPHY212Const.html#ge34c1f5817526945d96c7cda6689f342">TRX_IRQ_TRX_END</a> interrupt. In slotted operation mode <a class="el" href="grpRf212AutoRx.html#retv_tracstat">tracstat</a> can be either <a class="el" href="group__apiHalPHY212Const.html#g055049d569c7e50ecb31baa46ab3d6c1">TRAC_SUCCESS</a>, <a class="el" href="group__apiHalPHY212Const.html#g963a197c74012c7568d3229ff884c231">TRAC_SUCCESS_WAIT_FOR_ACK</a>, or <a class="el" href="group__apiHalPHY212Const.html#gd43f24dc2040e71f091bdc2377aa063b">TRAC_INVALID</a>.<p>
The internal timing for the ACK frame processing in RX_AACK mode is shown below:<p>
<pre></pre><p>
<pre>  == RX ==:== IDLE ==:=================== TX ====================:======== RX =======
         0          tack                                     88+tack  BPSK
         0          tack                                     22+tack  OQPSK
     +---|           |---+---+---+---+---+---+---+---+---+---+---|     time [symbols]
   --| F |-----+-----|   Preamble    |SFD|PHR|   ACK frame       |------------------&gt;
     +---|     |     |---+---+---+---+---+---+---+---+---+---+---|
         |     |     |                                           |
        t0a   t1a   t2a                                         t3a</pre><p>
<pre> </pre><p>
<ul>
<li>t0a : At this point in time the interrupt <a class="el" href="group__apiHalPHY212Const.html#ge34c1f5817526945d96c7cda6689f342">TRX_IRQ_TRX_END</a> is generated.</li><li>t1a : The transmission of the acknowledgement frame is initiated (see <a class="el" href="pgConst.html#tSlWait">tSlWait</a>) with a rising edge on <a class="el" href="grpIntroMCU.html#wirePinSleepTr">TRX_PIN_SLP_TR</a>.</li><li>t2a : The acknowledgement frame is transmitted.</li><li>t3a : The transmission of the ACK frame is completed.</li><li><code>tack = <a class="el" href="pgConst.html#tSlWait">tSlWait</a> + <a class="el" href="pgConst.html#tTR10">tTR10</a> </code></li></ul>
<p>
<dl class="note" compact><dt><b>Note:</b></dt><dd>Usually the frame upload is started after time t1a. If <a class="el" href="pgConst.html#tSlWait">tSlWait</a> is larger than the upload duration, the frame upload can alternatively be done between t0a and t1a.</dd></dl>
<div align="center">
<img src="inline_mscgraph_89.png" alt="inline_mscgraph_89" border="0" usemap="#inline_mscgraph_89.map">
<map name="inline_mscgraph_89.map"><area href="grpIntroStates.html#stRxAackOn" shape="rect" coords="421,26,479,39" alt="">
<area href="grpIntroStates.html#stRxAackBusy" shape="rect" coords="415,76,485,89" alt="">
<area href="pgConst.html#tFrame" shape="rect" coords="160,119,201,132" alt="">
<area href="pgConst.html#tSlWait" shape="rect" coords="160,194,207,207" alt="">
<area href="pgConst.html#tTR10" shape="rect" coords="460,319,495,332" alt="">
<area href="pgConst.html#t7" shape="rect" coords="160,344,177,357" alt="">
<area href="grpIntroStates.html#stRxAackOn" shape="rect" coords="421,501,479,514" alt="">
</map>
</div>
 <dl class="user" compact><dt><b>Code example</b></dt><dd><div class="fragment"><pre class="fragment">    <span class="comment">/* AT86RF212::RX_AACK_ON &amp;&amp; AT86RF212::BUSY_RX_AACK */</span>
    delay(tFrame);
    tracstat = <a class="code" href="group__apiHalFuncBasic.html#ge7ea3d090b5d26b73a5c62e2e61e0231" title="Read a value from a subregister.">trx_bit_read</a>(<a class="code" href="group__apiHalPHY212Sreg.html#g4692d9ea2770ff145d1c35c513cbf1d6">SR_TRAC_STATUS</a>);
    ASSERT(tracstat==SUCCESS_WAIT_FOR_ACK);
    <a class="code" href="group__apiHalFuncBasic.html#g7ffbe4411fb6d28f884fd3da4c206893" title="Set the level of the SLP_TR pin.">trx_pinset_slptr</a>(1);
    delay(t7);
    <a class="code" href="group__apiHalFuncBasic.html#g7ffbe4411fb6d28f884fd3da4c206893" title="Set the level of the SLP_TR pin.">trx_pinset_slptr</a>(0);
    frm = <a class="code" href="group__apiHalFuncBasic.html#g88ff4f45a0c4c7435d686150cc7fb4c2" title="Read a frame from the radio transceiver.">trx_frame_read</a>();
    <span class="comment">/* AT86RF212::RX_AACK_ON */</span>
</pre></div> </dd></dl>
</div>
<hr size="1"><address style="text-align: right;"><small>Generated on Mon Aug 17 13:35:01 2009 for SWPM AT86RF212 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.6 </small></address>
</body>
</html>
